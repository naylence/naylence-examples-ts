# Overlay Security — Browser Client

Browser-based client that demonstrates the overlay security profile end-to-end. It connects to the sentinel through Caddy, performs the OAuth2 PKCE flow, exchanges public keys during node attach, and invokes the math agent while envelopes are signed and verified in the browser runtime.

## Prerequisites

- Docker and Docker Compose (for the sentinel, OAuth2 server, Caddy, and math agent)
- Node.js 18+
- A trusted copy of the Caddy root certificate exposed by the example
- OAuth2 client credentials generated by `make init`

## 1. Start the overlay stack

From the example root (`examples/security/overlay`):

```bash
make start
```

This builds the TypeScript sources, launches the sentinel, OAuth2 server and math agent behind Caddy, and generates the `.env` files under `config/`.

## 2. Export and trust the Caddy root certificate

The browser must trust the self-signed CA that Caddy generates for `https://localhost`.

```bash
# From examples/security/overlay
mkdir -p browser/certs

docker run --rm \
  -v overlay_caddy-data:/data:ro \
  -v "$(pwd)/browser/certs:/out" \
  busybox cp /data/caddy/pki/authorities/local/root.crt /out/overlay-root.crt
```

Import `browser/certs/overlay-root.crt` into your OS trust store (Keychain Access on macOS, Certificates Manager on Windows, or `certutil` / system settings on Linux). Restart the browser afterwards to ensure the CA is trusted.

## 3. Generate `env.js`

`browser/env.js` is generated automatically by `make init` using `browser/env.template.js`. The template keeps all values hard-coded except for `FAME_ADMISSION_CLIENT_ID`, which appears as `${FAME_ADMISSION_CLIENT_ID}` and is filled with the OAuth client id created during secret generation.

- To refresh the configuration, rerun `make init` from the example root.
- If you need to tweak other values, edit `browser/env.template.js` and regenerate. Avoid editing the generated `env.js` directly; it gets overwritten.

## 4. Install dependencies & run the browser client

```bash
cd browser
npm install
npm run dev
```

Vite serves the app at `http://localhost:3000/`. The dev server proxies `/oauth/*` (and `/fame/*` WebSocket upgrades) to `https://localhost` so the browser can stay same-origin while Caddy still terminates TLS for the real services. The PKCE redirect target remains `http://localhost:3000/`.

## 5. Exercise the demo

1. Open the browser client at `http://localhost:3000/`.
2. Click **Run overlay demo**.
3. The fabric initiates PKCE. The first run performs a redirect to `https://localhost/oauth/authorize`, then returns to the Vite app.
4. After the redirect completes, the client executes:
   - `add(x, y)`
   - `multiply(x, y)`
   - `fib_stream(n)` (streaming Fibonacci numbers)
5. Status cards show the results, while the Fibonacci terms arrive live over the signed overlay channel.

If you need to reset the session, clear browser storage for the origin and rerun the demo.

## Troubleshooting

| Symptom | Fix |
| --- | --- |
| `TypeError: Failed to fetch` or the browser blocks the request | Ensure the Caddy root CA is trusted and the stack is running (`docker compose ps`). |
| Redirect loops between the app and `/oauth/authorize` | Clear session storage (`Session Storage → naylence.oauth2_pkce…`) and retry. |
| `invalid_request: client_id is required` | Double-check `FAME_ADMISSION_CLIENT_ID` in `browser/env.js`. |
| `Authorization state mismatch` | Make sure the redirect URI exactly matches `window.location.origin/`. |

## Related Files

- `browser/env.js` — runtime configuration for the browser client
- `browser/src/browser-client.ts` — PKCE + overlay demo implementation
- `config/.env.client` — generated environment used by the containerised client (reference for the client id)

```text
Overlay Security Demo setup
├── docker-compose.yml            # Sentinel, OAuth2 server, math agent, Caddy
├── src/                          # Backend sentinel/agent implementations
└── browser/                      # This browser client
```
